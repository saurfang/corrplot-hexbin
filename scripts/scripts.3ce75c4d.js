"use strict";angular.module("heatmapApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ngTable"]).config(["$provide",function(a){a.decorator("$rootScope",["$delegate",function(a){return Object.defineProperty(a.constructor.prototype,"$onRootScope",{value:function(b,c){var d=a.$on(b,c);return this.$on("$destroy",d),d},enumerable:!1}),a}])}]),angular.module("heatmapApp").factory("dataFactory",["$http",function(a){var b={},c=a.get("assets/flowers.json").then(function(a){return a.data});return b.flowers=function(){return c},b.points=function(a,b){var c=d3.random.normal(a/2,2),d=d3.random.normal(b/2,2),e=function(){return Math.ceil(5*Math.random())};return d3.range(2e3).map(function(){return[c(),d(),e()]})},b.getPearsonsCorrelation=function(a,b){var c=0;a.length==b.length?c=a.length:a.length>b.length?(c=b.length,console.error("x has more items in it, the last "+(a.length-c)+" item(s) will be ignored")):(c=a.length,console.error("y has more items in it, the last "+(b.length-c)+" item(s) will be ignored"));for(var d=[],e=[],f=[],g=0;c>g;g++)d.push(a[g]*b[g]),e.push(a[g]*a[g]),f.push(b[g]*b[g]);for(var h=0,i=0,j=0,k=0,l=0,g=0;c>g;g++)h+=a[g],i+=b[g],j+=d[g],k+=e[g],l+=f[g];var m=c*j-h*i,n=c*k-h*h,o=c*l-i*i,p=Math.sqrt(n*o),q=m/p;return q},b}]),angular.module("heatmapApp").controller("MainCtrl",["$scope",function(){}]),angular.module("heatmapApp").controller("hexbinCtrl",["$rootScope","$scope",function(a,b){b.binSize=20;var c=20,d=d3.scale.linear().domain([0,15]).range(["white","steelblue"]).interpolate(d3.interpolateLab);b.initSlider=function(){var a=function(){b.binSize=c.getValue(),b.$apply()},c=$("#binSize").slider().slider("setValue",b.binSize).on("slideStop",a).data("slider")},b.initLegend=function(){var a={top:5,right:20,bottom:15,left:5},b=$("#legend").width(),e=45,f="legendGradient",g=d3.select("#legend").append("svg").attr("width","100%").attr("height",e);g.append("g").append("defs").append("linearGradient").attr("id",f).attr("x1","0%").attr("x2","100%").attr("y1","0%").attr("y2","0%"),g.append("rect").attr("fill","url(#"+f+")").attr("x",a.left).attr("y",a.top).attr("width",b-a.left-a.right).attr("height",e-a.top-a.bottom).style("stroke","black").style("stroke-width","1px"),g.append("text").attr("class","legendText").attr("text-anchor","middle").attr("x",a.left).attr("y",e).text("0"),g.append("text").attr("class","legendText").attr("text-anchor","middle").attr("x",b-a.right).attr("y",e).text(c+"+");var h=d3.select("#"+f).selectAll("stop").data(d3.range(c).map(function(a){return{percent:a/c,color:d(a)}}));h.enter().append("stop"),h.attr("offset",function(a){return a.percent}).attr("stop-color",function(a){return a.color})},b.initHexbin=function(){var c={top:20,right:20,bottom:40,left:50},e=$("#hexbin").width()-c.left-c.right,f=500-c.top-c.bottom,g=[],h=function(a){return a.reduce(function(a,b){return a+b[2]},0)},i=d3.hexbin().x(function(a){return j(a[0])}).y(function(a){return k(a[1])}).size([e,f]).radius(b.binSize),j=d3.scale.linear().range([0,e]),k=d3.scale.linear().range([f,0]),l=d3.svg.axis().scale(j).orient("bottom").tickSize(6,-f),m=d3.svg.axis().scale(k).orient("left").tickSize(6,-e),n=function(){q.select(".x.axis").call(l),q.select(".y.axis").call(m),s()},o=d3.behavior.zoom().x(j).y(k).on("zoom",n),p=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(a){var b=a.reduce(function(a,b){return[a[0]+b[0]*b[2],a[1]+b[1]*b[2],a[2]+b[2]]},[0,0,0]),c=d3.format(".2f")(b[0]/b[2]),d=d3.format(".2f")(b[1]/b[2]);return"<span>("+c+","+d+"): "+b[2]+"</span>"}),q=d3.select("#hexbin").append("svg").attr("width",e+c.left+c.right).attr("height",f+c.top+c.bottom).append("g").attr("transform","translate("+c.left+","+c.top+")");q.append("rect").attr("class","pane").attr("width",e).attr("height",f).call(o),q.append("clipPath").attr("id","clip").append("rect").attr("class","mesh").attr("width",e).attr("height",f),q.call(p);var r=q.append("g").attr("clip-path","url(#clip)").selectAll(".hexagon");q.append("g").attr("class","y axis").call(m),q.append("g").attr("class","x axis").attr("transform","translate(0,"+f+")").call(l);var s=(q.append("text").attr("class","x label").attr("text-anchor","middle").attr("x",e/2).attr("y",f+30),q.append("text").attr("class","y label").attr("text-anchor","middle").attr("x",-f/2).attr("y",-40).attr("transform","rotate(-90)"),function(){r=r.data(i(g),function(a){return a.i+","+a.j}),r.exit().remove(),r.enter().append("path").attr("class","hexagon").on("mouseover",p.show).on("mouseout",p.hide),r.attr("transform",function(a){return"translate("+a.x+","+a.y+")"}).attr("d",i.hexagon()).style("fill",function(a){return d(h(a))})}),t=function(a){j.domain(d3.extent(g,function(a){return a[0]})),k.domain(d3.extent(g,function(a){return a[1]})),o=o.x(j).y(k);var b=q.transition().duration(500);b.select(".x.axis").call(l),b.select(".x.label").text(a[0]),b.select(".y.axis").call(m),b.select(".y.label").text(a[1])};b.$onRootScope("hexbinChanged",function(){g=a.selectedHexbins,t(a.selectedTraits),s()}),b.$watch("binSize",function(){i=i.radius(b.binSize),s()})}}]),angular.module("heatmapApp").controller("correlationCtrl",["$rootScope","$scope","dataFactory","ngTableParams",function(a,b,c,d){b.traits=[];var e=[];b.correlations=[],c.flowers().then(function(a){b.traits=a.traits,e=a.values;var d=[];b.traits.forEach(function(a){var f={trait:a},g=e.map(function(b){return b[a]});b.traits.forEach(function(a){var b=e.map(function(b){return b[a]});f[a]=c.getPearsonsCorrelation(g,b)}),d.push(f)}),b.correlations=d,b.tableParams.reload()}),b.updateHexbin=function(b,c){a.selectedTraits=[b,c],a.selectedHexbins=e.map(function(a){return[a[b],a[c],1]}),a.$emit("hexbinChanged")},b.format=d3.format("%.2f");var f=d3.scale.quantile().domain([-1,1]).range(d3.range(11));b.color=function(a,b){return a.trait===b?"white":colorbrewer.RdYlGn[11][f(a[b])]},b.tableParams=new d({page:1,count:b.traits.length},{counts:[],total:b.traits.length,getData:function(a){var c=b.correlations;a.resolve(c)}})}]);